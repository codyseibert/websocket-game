<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style>
      .player {
        position: absolute;
        width: 10px;
        height: 10px;
      }

      #board {
        width: 300px;
        height: 300px;
        background: gray;
      }
    </style>
  </head>
  <body>
    <div id="board"></div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();

      const boardEl = document.getElementById("board");

      const playersMap = {};
      const keysDown = {
        up: false,
        down: false,
        left: false,
        right: false,
      };

      document.addEventListener("keydown", (e) => {
        if (e.key === "d") {
          keysDown["right"] = true;
        } else if (e.key === "w") {
          keysDown["up"] = true;
        } else if (e.key === "a") {
          keysDown["left"] = true;
        } else if (e.key === "s") {
          keysDown["down"] = true;
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.key === "d") {
          keysDown["right"] = false;
        } else if (e.key === "w") {
          keysDown["up"] = false;
        } else if (e.key === "a") {
          keysDown["left"] = false;
        } else if (e.key === "s") {
          keysDown["down"] = false;
        }
      });

      setInterval(() => {
        if (keysDown["right"]) {
          socket.emit("right");
        } else if (keysDown["up"]) {
          socket.emit("up");
        } else if (keysDown["left"]) {
          socket.emit("left");
        } else if (keysDown["down"]) {
          socket.emit("down");
        }
      }, 1000 / 30);

      const getRandomColor = () => Math.floor(255 * Math.random());

      socket.on("players", (players) => {
        try {
          for (const player of players) {
            if (!playersMap[player.id]) {
              playersMap[player.id] = player;
              const playerEl = document.createElement("div");
              playerEl.classList.add("player");
              boardEl.appendChild(playerEl);
              player.el = playerEl;
              player.el.style.background = `rgb(${getRandomColor()}, ${getRandomColor()}, ${getRandomColor()})`;
            }
            playersMap[player.id].el.style.left = player.x + "px";
            playersMap[player.id].el.style.top = player.y + "px";
          }
        } catch (err) {
          console.log(err);
        }
      });

      socket.on("playerDisconnected", (playerId) => {
        console.log("playerDisconnected", playerId);
        const player = playersMap[playerId];
        delete playersMap[playerId];
        player.el.remove();
      });
    </script>
  </body>
</html>
